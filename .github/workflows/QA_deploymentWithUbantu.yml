name: Angular Build and Deploy to IIS (Self-Hosted, Inline)

on:
  push:
    branches:
      - main1123

jobs:
  build-and-deploy:
    runs-on: [self-hosted, dev_BPC_Runner]

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: üßπ Remove node_modules if exists
        shell: powershell
        run: |
          if (Test-Path "node_modules") {
            Remove-Item "node_modules" -Recurse -Force
          }

      - name: üîó Symlink shared node_modules (Windows)
        shell: cmd
        run: mklink /D node_modules "D:\Angular_ODOS_UI\ODOS_DEV_UI\node_modules"

      - name: üî® Post Install Packages
        run: npm run postinstall

      - name: üî® Build Angular app (with increased memory)
        run: node --max_old_space_size=4096 ./node_modules/@angular/cli/bin/ng build --configuration production --aot

      - name: üìÅ Prepare D:\Deploy\AngularApp folder
        shell: powershell
        run: |
          $deployPath = "D:\Deploy\AngularApp"
          if (Test-Path $deployPath) {
            Remove-Item $deployPath -Recurse -Force
          }
          New-Item -ItemType Directory -Path $deployPath | Out-Null
          $distFolder = Get-ChildItem .\dist | Where-Object { $_.PSIsContainer } | Select-Object -First 1
          Copy-Item ".\dist\$($distFolder.Name)\*" -Destination $deployPath -Recurse -Force

      - name: üõë Stop IIS Site and App Pool
        shell: powershell
        run: |
          Import-Module WebAdministration
          $siteName = "ODOS"
          $appPoolName = "ODOS"

          if (Test-Path "IIS:\Sites\$siteName") {
            Write-Host "Stopping site '$siteName'..."
            Stop-Website -Name $siteName
          } else {
            Write-Host "‚ö†Ô∏è IIS Site '$siteName' not found."
          }

          if (Test-Path "IIS:\AppPools\$appPoolName") {
            Write-Host "Stopping App Pool '$appPoolName'..."
            if ((Get-WebAppPoolState -Name $appPoolName).Value -ne "Stopped") {
              Stop-WebAppPool -Name $appPoolName
            }
          } else {
            Write-Host "‚ö†Ô∏è App Pool '$appPoolName' not found."
          }

          Start-Sleep -Seconds 10

      - name: üßπ Clean old IIS backups (keep last 3)
        shell: powershell
        run: |
          $backupRoot = "D:\IIS_Backups\ODOS_UI_Backup"
          if (Test-Path $backupRoot) {
            $backups = Get-ChildItem $backupRoot | Sort-Object LastWriteTime -Descending
            if ($backups.Count -gt 3) {
              $backups | Select-Object -Skip 5 | Remove-Item -Recurse -Force
              Write-Host "üßπ Deleted old backups, kept latest 3."
            }
          }

      - name: üöö Deploy to local server folder (with ZIP backup)
        shell: powershell
        continue-on-error: true
        run: |
          Start-Sleep -Seconds 20

          $siteName = "ODOS"
          $source = "D:\Deploy\AngularApp"
          $destination = "C:\inetpub\wwwroot\ODOS_UI"
          $backupRoot = "D:\IIS_Backups\ODOS_UI_Backup"
          $timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
          $backupFolder = Join-Path $backupRoot "ODOS-Backup_$timestamp"

          if (-not (Test-Path $destination)) {
            New-Item -ItemType Directory -Path $destination | Out-Null
          }

          Write-Host "Backing up existing files to: $backupFolder.zip"
          if (-not (Test-Path $backupRoot)) {
            New-Item -ItemType Directory -Path $backupRoot | Out-Null
          }

          try {
            Compress-Archive -Path "$destination\*" -DestinationPath "$backupFolder.zip" -Force
            Write-Host "‚úÖ Backup created successfully."
          } catch {
            Write-Host "‚ö†Ô∏è Backup failed (maybe no existing files). Continuing..."
          }

          Write-Host "Copying new files to IIS folder..."
          Copy-Item "$source\*" "$destination" -Recurse -Force

      - name: ‚ñ∂Ô∏è Start IIS Site and App Pool (Always)
        if: always()
        shell: powershell
        run: |
          Import-Module WebAdministration
          $siteName = "ODOS"
          $appPoolName = "ODOS"

          if (Test-Path "IIS:\AppPools\$appPoolName") {
            Start-WebAppPool -Name $appPoolName
            Write-Host "Started App Pool '$appPoolName'"
          } else {
            Write-Host "‚ö†Ô∏è App Pool '$appPoolName' not found."
          }

          if (Test-Path "IIS:\Sites\$siteName") {
            Start-Website -Name $siteName
            Write-Host "Started IIS Site '$siteName'"
          } else {
            Write-Host "‚ö†Ô∏è IIS Site '$siteName' not found."
          }

      - name: üßπ Clean temporary deploy folder
        if: always()
        shell: powershell
        run: |
          $deployPath = "D:\Deploy\AngularApp"
          if (Test-Path $deployPath) {
            Remove-Item $deployPath -Recurse -Force
            Write-Host "Cleaned deploy folder."
          }
